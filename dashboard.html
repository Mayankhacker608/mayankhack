<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raksha - SOS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-sA+e2Jb7D0S0rj8BkX1v4KxO2s+Q0+PpMZ4hA3N0fQQ="
      crossorigin=""
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      #sosBtn {
        transition: transform 0.1s;
      }
      #sosBtn:active {
        transform: scale(0.95);
        animation: pulse 0.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
        50% {
          box-shadow: 0 0 20px 10px rgba(255, 0, 0, 0.3);
        }
      }
    </style>
  </head>
  <body class="bg-pink-50 min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-pink-600 text-white p-4 flex justify-between items-center">
      <h1 class="font-bold text-xl">🚨 Raksha</h1>
      <ul class="flex space-x-4">
        <li>
          <a
            href="index.html"
            class="hover:underline hover:text-gray-200 transition"
            >Home</a
          >
        </li>
        <li>
          <a
            href="profile.html"
            class="hover:underline hover:text-gray-200 transition"
            >Profile</a
          >
        </li>
        <li>
          <a href="dashboard.html" class="font-bold underline">Dashboard</a>
        </li>
        <li>
          <a
            href="login.html"
            class="hover:underline hover:text-gray-200 transition"
            >Login</a
          >
        </li>
      </ul>
    </nav>

    <!-- Dashboard -->
    <main
      class="flex-1 flex flex-col items-center justify-center space-y-6 p-4"
    >
      <h2 class="text-2xl font-bold mb-4">🚨 SOS Dashboard</h2>

      <!-- User Info -->
      <div
        id="userInfo"
        class="w-full max-w-lg bg-white p-4 rounded-2xl shadow text-gray-700"
      ></div>

      <!-- SOS Button -->
      <button
        id="sosBtn"
        class="bg-red-600 text-white px-8 py-6 rounded-full shadow-2xl text-xl font-bold"
      >
        🚨 SEND SOS
      </button>

      <!-- Quick Actions -->
      <div class="flex flex-wrap justify-center space-x-4 mt-4">
        <button
          id="callPolice"
          class="bg-blue-600 text-white px-4 py-2 rounded shadow"
        >
          📞 Call 112
        </button>
        <button
          id="callContact1"
          class="bg-green-600 text-white px-4 py-2 rounded shadow"
        >
          📞 Call Contact
        </button>
        <button
          id="sendSms"
          class="bg-yellow-500 text-white px-4 py-2 rounded shadow"
        >
          📩 Send SMS
        </button>
      </div>

      <!-- SOS Status -->
      <p id="status" class="mt-4 text-gray-700 font-medium"></p>

      <!-- Map -->
      <div id="map" class="w-full max-w-lg h-64 rounded-2xl shadow mt-4"></div>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-o9N1jQ9uxF7G+7YNRq6a4P7t4sRO/T0XcZ+1/JvC4qM="
      crossorigin=""
    ></script>

    <script>
      const profile = JSON.parse(localStorage.getItem("profile")) || {
        fullName: "Jane Doe",
        bloodGroup: "O+",
        address: "Mumbai, India",
        contacts: ["+911234567890", "+919876543210"],
      };
      const statusEl = document.getElementById("status");

      // Show profile info
      document.getElementById("userInfo").innerHTML = `
        <b>Name:</b> ${profile.fullName}<br>
        <b>Blood Group:</b> ${profile.bloodGroup}<br>
        <b>Address:</b> ${profile.address}<br>
        <b>Contacts:</b><br>${(profile.contacts || [])
          .map((c) => "📞 " + c)
          .join("<br>")}
      `;

      // Initialize map
      let map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);
      let marker;

      function updateLocation(lat, lon) {
        map.setView([lat, lon], 15);
        if (marker) marker.setLatLng([lat, lon]);
        else marker = L.marker([lat, lon]).addTo(map);
      }

      function getLocation(callback) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => callback(pos.coords.latitude, pos.coords.longitude),
            (err) => (statusEl.innerText = "⚠️ Location access denied!")
          );
        } else {
          statusEl.innerText = "⚠️ Geolocation not supported!";
        }
      }

      // Initialize user's location
      getLocation(updateLocation);

      // Auto-update map every 10s
      setInterval(() => getLocation(updateLocation), 10000);

      // SOS button logic with hold
      const sosBtn = document.getElementById("sosBtn");
      let sosTimeout;
      sosBtn.addEventListener("mousedown", () => {
        statusEl.innerText = "Hold 3s to send SOS...";
        sosTimeout = setTimeout(sendSOS, 3000);
      });
      sosBtn.addEventListener("mouseup", () => {
        clearTimeout(sosTimeout);
        statusEl.innerText = "";
      });
      sosBtn.addEventListener("mouseleave", () => clearTimeout(sosTimeout));

      function sendSOS() {
        getLocation((lat, lon) => {
          const msg = `Help! My location: https://maps.google.com/?q=${lat},${lon}`;
          statusEl.innerText = "📍 SOS sent! Opening SMS...";
          if (navigator.vibrate) navigator.vibrate(200);
          if (profile.contacts && profile.contacts.length > 0) {
            profile.contacts.forEach((c) => {
              window.open(`sms:${c}?body=${encodeURIComponent(msg)}`, "_blank");
            });
          }
          updateLocation(lat, lon);
        });
      }

      // Quick action buttons
      document.getElementById("callPolice").onclick = () =>
        (window.location.href = "tel:112");
      document.getElementById("callContact1").onclick = () => {
        if (profile.contacts && profile.contacts[0])
          window.location.href = `tel:${profile.contacts[0]}`;
      };
      document.getElementById("sendSms").onclick = sendSOS;
    </script>
  </body>
</html>
