<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raksha - SOS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      #sosBtn {
        transition: transform 0.1s;
      }
      #sosBtn:active {
        transform: scale(0.95);
        animation: pulse 0.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
        50% {
          box-shadow: 0 0 20px 10px rgba(255, 0, 0, 0.3);
        }
      }
      #gestureCam {
        border: 2px solid #db2777;
        border-radius: 10px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body class="bg-pink-50 min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-pink-600 text-white relative z-50">
      <div
        class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16"
      >
        <span class="text-xl font-extrabold flex items-center gap-2">
          <span class="text-2xl">üö®</span> Raksha
        </span>
        <div class="hidden md:flex gap-6 font-medium">
          <a href="index.html">Home</a>
          <a href="profile.html">Profile</a>
          <a href="dashboard.html" class="font-bold underline">Dashboard</a>
          <a href="login.html">Login</a>
        </div>
      </div>
    </nav>

    <!-- Dashboard -->
    <main
      class="flex-1 flex flex-col items-center justify-center space-y-6 p-4"
    >
      <h2 class="text-2xl font-bold mb-4">üö® SOS Dashboard</h2>

      <!-- Profile Info -->
      <div
        id="userInfo"
        class="w-full max-w-lg bg-white p-4 rounded-2xl shadow text-gray-700"
      ></div>

      <!-- SOS Button -->
      <button
        id="sosBtn"
        class="bg-red-600 text-white px-8 py-6 rounded-full shadow-2xl text-xl font-bold"
      >
        üö® SEND SOS
      </button>

      <!-- Quick Actions -->
      <div class="flex flex-wrap justify-center space-x-2 mt-4 gap-2">
        <button
          id="callPolice"
          class="bg-blue-600 text-white px-4 py-2 rounded shadow"
        >
          üìû Call 112
        </button>
        <button
          id="callContact1"
          class="bg-green-600 text-white px-4 py-2 rounded shadow"
        >
          üìû Call Contact
        </button>
        <button
          id="sendSms"
          class="bg-yellow-500 text-white px-4 py-2 rounded shadow"
        >
          üì© Send SMS
        </button>
      </div>

      <!-- Status -->
      <p id="status" class="mt-4 text-gray-700 font-medium"></p>

      <!-- Map -->
      <div id="map" class="w-full max-w-lg h-64 rounded-2xl shadow mt-4"></div>

      <!-- Women Safety Info -->
      <div class="w-full max-w-lg bg-white p-4 rounded-2xl shadow mt-6">
        <h3 class="text-lg font-semibold mb-2">üõ°Ô∏è Women Safety Tips</h3>
        <ul class="list-disc list-inside text-gray-700 space-y-1">
          <li>Always share your location with a trusted contact.</li>
          <li>Use well-lit and populated routes at night.</li>
          <li>Keep emergency numbers saved and easily accessible.</li>
          <li>Trust your instincts and avoid unsafe areas.</li>
          <li>Use the SOS button in case of danger.</li>
        </ul>
      </div>

      <!-- Gesture SOS -->
      <h3 class="text-lg font-semibold mt-6">‚úã Gesture SOS (Raise Hand)</h3>
      <video
        id="gestureCam"
        autoplay
        playsinline
        width="320"
        height="240"
      ></video>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
      /* Firebase Init */
      const firebaseConfig = {
        apiKey: "YOUR_KEY",
        projectId: "YOUR_PROJECT_ID",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      /* Profile Data */
      const profile = JSON.parse(localStorage.getItem("profile")) || {
        fullName: "Jane Doe",
        email: "demo@email.com",
        phone: "+91 XXXXXXXX",
        gender: "Female",
        bloodGroup: "O+",
        home: "Mumbai, India",
        work: "N/A",
        contacts: ["+911234567890"],
        sos: { sms: true, email: false, app: true, message: "Help me!" },
      };

      const statusEl = document.getElementById("status");
      document.getElementById("userInfo").innerHTML = `
        <b>Name:</b> ${profile.fullName}<br>
        <b>Phone:</b> ${profile.phone}<br>
        <b>Contacts:</b><br>${profile.contacts
          .map((c) => "üìû " + c)
          .join("<br>")}
      `;

      /* Map Setup */
      let map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map
      );
      let marker;
      let sosHistory = JSON.parse(localStorage.getItem("sosHistory")) || [];
      function updateLocation(lat, lon) {
        map.setView([lat, lon], 15);
        if (marker) marker.setLatLng([lat, lon]);
        else marker = L.marker([lat, lon]).addTo(map);
      }
      function showHotspots() {
        if (sosHistory.length > 0)
          L.heatLayer(sosHistory, { radius: 25 }).addTo(map);
      }
      function getLocation(cb) {
        navigator.geolocation.getCurrentPosition(
          (p) => cb(p.coords.latitude, p.coords.longitude),
          () => (statusEl.innerText = "‚ö†Ô∏è Location denied!")
        );
      }
      getLocation(updateLocation);
      setInterval(() => getLocation(updateLocation), 10000);
      showHotspots();

      /* SOS Button - Mobile + Desktop */
      const sosBtn = document.getElementById("sosBtn");
      let sosTimeout;

      ["mousedown", "touchstart"].forEach((ev) =>
        sosBtn.addEventListener(ev, () => {
          statusEl.innerText = "Hold 3s to send SOS...";
          sosTimeout = setTimeout(sendSOS, 3000);
        })
      );
      ["mouseup", "touchend", "touchcancel"].forEach((ev) =>
        sosBtn.addEventListener(ev, () => {
          clearTimeout(sosTimeout);
          statusEl.innerText = "";
        })
      );

      async function sendSOS() {
        getLocation(async (lat, lon) => {
          let msg =
            (profile.sos?.message || "Help me! I am in danger.") +
            ` My location: https://maps.google.com/?q=${lat},${lon}`;
          statusEl.innerText = "üìç SOS triggered...";
          if (navigator.vibrate) navigator.vibrate(200);
          updateLocation(lat, lon);
          sosHistory.push([lat, lon, 1]);
          localStorage.setItem("sosHistory", JSON.stringify(sosHistory));
          showHotspots();

          // Firestore log
          try {
            await db.collection("sos_events").add({
              user: profile.fullName,
              phone: profile.phone,
              lat,
              lon,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              message: msg,
            });
          } catch (e) {
            console.error("Firestore log error", e);
          }

          // WhatsApp Alert
          profile.contacts.forEach((c) => {
            const phone = c.replace(/\D/g, "");
            const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(
              msg
            )}`;
            const a = document.createElement("a");
            a.href = waLink;
            a.target = "_blank";
            a.click();
          });

          // SMS API fallback
          try {
            const resp = await fetch("/api/send-sms", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contacts: profile.contacts,
                message: msg,
              }),
            });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data?.error);
            statusEl.innerText = "‚úÖ SOS sent via SMS + WhatsApp";
          } catch (err) {
            console.error(err);
            statusEl.innerText = "‚ö†Ô∏è SMS API failed, WhatsApp used";
          }
        });
      }

      /* Gesture SOS */
      async function startGestureSOS() {
        const video = document.getElementById("gestureCam");
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        video.srcObject = stream;
        const model = await handpose.load();
        setInterval(async () => {
          const pred = await model.estimateHands(video);
          if (pred.length > 0) {
            statusEl.innerText = "‚úã Hand detected!";
            if (pred[0].boundingBox.topLeft[1] < 100) {
              statusEl.innerText = "‚úã Gesture SOS Triggered!";
              sendSOS();
            }
          }
        }, 3000);
      }
      startGestureSOS();

      /* Voice Trigger */
      if (
        "webkitSpeechRecognition" in window ||
        "SpeechRecognition" in window
      ) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR();
        rec.continuous = true;
        rec.onresult = (e) => {
          const txt =
            e.results[e.results.length - 1][0].transcript.toLowerCase();
          if (txt.includes("help") || txt.includes("bachao")) sendSOS();
        };
        rec.start();
      }
    </script>
  </body>
</html>
